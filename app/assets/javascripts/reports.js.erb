//-----> REPORTS - INDEX.HTML.ERB
document.addEventListener("turbolinks:load", function() {
  set_up_dropdowns();
  set_up_datetimepickers();
})

function set_up_dropdowns() {
  $('#select_on_employees').multiselect({
    nonSelectedText: 'Employees',
    includeSelectAllOption: true
  });

  $('#select_on_tickets').multiselect({
    nonSelectedText: 'Tickets',
    includeSelectAllOption: true
  });

  $('#select_on_tickets_status').multiselect({
    nonSelectedText: 'Status',
    includeSelectAllOption: true
  });

  $('#select_on_projects').multiselect({
    nonSelectedText: 'Projects',
    includeSelectAllOption: true,
    onChange: function(option, checked) {
      selected_projects = $('#select_on_projects').val().map(Number);
      $.ajax({
        beforeSend: function(xhr) {xhr.setRequestHeader('X-CSRF-Token', $('meta[name="csrf-token"]').attr('content'))},
        url: "reports/refill_employees_dropdown",
        type: "POST",
        data: {"selected_projects": selected_projects},
        success: function (data){
          data = data["employees"].filter((v, i, a) => a.indexOf(v) === i); //to eliminate duplicates
          var htm = '';
          for(var i = 0; i < data.length; ++i) {
            htm += '<option>' + data[i] + '</option>';
            $('#select_on_employees').html(htm);
            $('#select_on_employees').multiselect('rebuild');
          }
        }
      });
    }
  });
};

function set_up_datetimepickers() {
  $( "#report-from-datetimepicker" ).datetimepicker(
    {
      minDate: moment(), //to disable past dates
      format: 'YYYY-MM-DD'
    }
  );

  $( "#report-to-datetimepicker" ).datetimepicker(
    {
      minDate: moment(), //to disable past dates
      format: 'YYYY-MM-DD'
    }
  );
}
